<h1> Te controleren/ aan te vullen:</h1>
<table id="statustable">
  <thead>
    <tr>
      <td/><td/>
      <th> Name </th>
      <th> Role </th>
      <th> PPN </th>

    </tr>	
  </thead>
  <tbody>
  	{% for contributor in contributors %}
   <tr id='row_{{loop.index}}' name="{{contributor['familyname']}}">
     <td class="button"><input onclick="move_row(this,1);" type="button" value="&#8679;" /></td>
     <td class="button"><input onclick="move_row(this,0);" type="button" value="&#8681;" /></td>
     <td class='tdinput'><input id="aut_name_{{loop.index}}"  name='aut_name' type="text" value="{{contributor['givenname']}}{{contributor['prefix']}} @{{contributor['familyname']}}"/></td>
     <td class='tdinput'>
      <input value="{{contributor['legible']}} [{{contributor['ggc_code']}}]" class="role" id="role_{{loop.index}}">
    </td>
    <td>
      <input type="button" value="Zoek_ajax" id="thesaureerButton_{{loop.index}}" onclick="thesaureer_ajax({{loop.index}})"/>
    </td>

  </tr>

  {% endfor %}
</tbody>
<tfoot>  
  <tr><td/><td/><td><input type="button" value="Voeg naam toe" onclick="add_row()" /></td></tr></tfoot>
</table>

<script type=text/javascript> 
  var role_options = [];
  {% for role in role_list %}
  role_options.push({
    label: "{{role['legible']}} [{{role['ggc_code']}}]"
  });
  {%endfor%}

  $('input[class=role]').autocomplete({
    source: role_options
  });

  var maxIndex = $("#statustable > tbody > tr").length

  function move_row(e, up) {
    var row = $(e).closest('tr');
    if (up)
      row.prev().before(row);
    else
      row.next().after(row);
  }



  function open_popup (url, width=700, height=400) {
    window.open(url,"_blank","width=700,height=400") ;
  }

  function add_to_author_list(row){

    var url = "{{ url_for('contributor.authorpage', id='placeholder')}}".replace('placeholder', row.ppn);
    var link = '<a class="action"  href="#" onClick="open_popup(\''+url+'\')"; return false;>'+row.ppn+'</a>';

    var years = [row.birthyear,'-',row.deathyear].join('');

    $("#author_list > tbody").append($('<tr>')
      .append($('<td>').append(link))
      .append($('<td>').text(row.foaf_name))
      .append($('<td>').text(years))
      .append($('<td>',{css: {"backgroundColor":getColorForPercentage(row.name_score)}}).text(Math.round(row.name_score)))
      );
  }


  function thesaureer_ajax(index){
    var authornameId = "aut_name_" + index;
    var authorname = $("#"+ authornameId).val();
    console.log('Thesaureer name', authorname)

    $('#thesaureer_title').text('NTA-records voor '+authorname);

    $.ajax({
      url: '/thesaureer_2',
      data: {'author_name': authorname},
      dataType: 'json',
      success: function(response) {
        console.log(response);               

        if (response.length<1) {
          $('#placeholder').text('Geen records gevonden');
          $("#author_list > thead").empty()       
        }
        else {
          $('#placeholder').empty()
          if ($("#author_list > thead > tr").length<2){
              $("#author_list > thead").append($('<tr>')
                .append($('<td/>')).append($('<td/>')).append($('<td/>')).append($('<td/>')
                  .text('Scores'))
                ).append($('<tr>')
                .append($('<td>').text('PPN'))
                .append($('<td>').text('Name'))
                .append($('<td>').text('Leefjaren'))
                .append($('<td>').text('Name')));
            }               
          }

          $("#author_list > tbody").empty()       
          for(var i = 0; i< response.length; i++){
            console.log(response[i].id)
            add_to_author_list(response[i])
          }

        },
        error: function(error) {
          console.log(error);
        }
      });
  }

  function add_row() {
    maxIndex ++;
    $("#statustable > tbody").append($('<tr>')
      .append($('<td>').append('<input onclick="move_row(this,1);" type="button" value="&#8679;">')) 
      .append($('<td>').append('<input onclick="move_row(this,0);" type="button" value="&#8681;">')) 
      .append($('<td>').append('<input id="aut_name_' + maxIndex + '" type="text" placeholder="Voornaam @Achternaam" value="">'))
      .append($('<td>').append('<input class="role" id="role_' + maxIndex + '">'))
      .append($('<td>').append('<input onclick="thesaureer_ajax('+maxIndex+');" type="button" value="Zoek_ajax" id="thesaureerButton_'+maxIndex+'">'))
      )
    $('input[id="role_' + maxIndex + '"]').autocomplete({
      source: role_options
    });
  }

  var getColorForPercentage = function(this_perc, low=0.5) {
    var percentColors = [
    { pct: 0.0, color: { r: 0xff, g: 0x00, b: 0 } },
    { pct: low, color: { r: 0xff, g: 0xff, b: 0 } },
    { pct: 1.0, color: { r: 0x00, g: 0xff, b: 0 } } ];

    this_perc = Number(this_perc) / 100;
    for (var i = 1; i < percentColors.length - 1; i++) {
      if (this_perc < percentColors[i].pct) {
        break;
      }
    }
    var lower = percentColors[i - 1];
    var upper = percentColors[i];
    var range = upper.pct - lower.pct;
    var rangePct = (this_perc - lower.pct) / range;
    var pctLower = 1 - rangePct;
    var pctUpper = rangePct;
    var color = {
      r: Math.floor(lower.color.r * pctLower + upper.color.r * pctUpper),
      g: Math.floor(lower.color.g * pctLower + upper.color.g * pctUpper),
      b: Math.floor(lower.color.b * pctLower + upper.color.b * pctUpper)
    };
    return 'rgb(' + [color.r, color.g, color.b].join(',') + ')';
  };

</script>